<!--

TODO:
* fireball - on('cleared',
* Fireball('#suggestions').delete(id)
-->

<style>
#current_suggesion { margin-top:20px; text-align:center; }
#audio_info { text-align:center; margin-top:20px; }
#audio_info .sigil { font-size:28px; }
#events { margin-top:20px; }
</style>


<div id="audio" class="page">
	<div id="experience" class="x">
		<b data-set="text:author_names">Joe and Dina</b>
		<span data-set="text:did_what">made this experience / are making an experience</span> 
		for
		<b data-set="text:where">Music Studios Archway</b>
	</div>

	<div id="suggestions" class="bh flex xx x">
	   <div class="suggestion">
	      <span data-set="text:framing">
		      Current suggestion is / Dina suggested
		   </span>
		   <b data-set="text:text">
    		   "Hum a resonant pitch"
    	   </b>
		   <button id="accept_suggestion" class="xx">Accept</button>
    	</div>
	</div>


    <div id="audio_info">
        <audio></audio>
        <div data-set="text:sigil">&#9654;</div>
        Playing <b data-set="text:song_name">Dina Maccabee\'s "The Rooster"</b>
        <span data-set="text:time_left">(20s left)</span>
    </div>
	
	<div class="flex x" id="actions">
	    <div class="action">
			<i class="ts" style="color:#666">1s ago</i>
			<b class="who">Dina</b>
			<span class="what">accepted your suggestion</span>
		</div>

        <!--
			<i style="color:#666">3s ago</i>
			You suggested "Vocay Fry".

			<i style="display:block; margin-right:5px; color:#666">3s ago</i>
			<div class="flex">Dina accepted the suggestion "Play Air Guitar".</div>
		-->
	</div>


	<form id="suggestion_form" class="xx">
			<b>Suggest something during THE INTRO</b>
			<div class="bh">
				<input class="flex" placeholder="Suggest a dance move...">
				<button>Send</button>
			</div>
			<hr>
			<div class="buttons">
				<button style="background:gray">Dance Move</button>
				<button>Fitness activity</button>
				<button>Pose</button>
				<button>Thought Feeling</button>
				<button>Sounding</button>
				<button>Interaction</button>
				<button>Walking direction</button>
				<button>Object to examine</button>
			</div>
		</div>
	</form>
</div>


<script type="text/javascript">
var mode, my_name, experience_id, room_id;

// data model
//   experience.authors = { id=>name }
//   experience.where = place name
//
//  sugg = {from_name, text}
// 
//  audio_info = {song_name, base_url, state, t0}

// GOOD
//  action = {who, what}

// on compose

function record(who, song_id, where){
	page = 'audio';
	mode = 'record';
	my_name = who;
	songName = song_id;
	exp_id = F.child('/experiences').push({
		where: where,
		song: song_id,
		authors: { who : who }
	}).name();
	room_id = F.child("/actions/" + exp_id).push().name();
	F.child("/actions/" + exp_id + '/' + room_id).push({
		who: who,
		what: 'Joined'
	});
	Fireball.set('$experience_id', exp_id);
	Fireball.set('$room_id', room_id);
}

		// '#actions':     "/actions/$experience_id/$room_id[]",
		// '#suggestions': "/live_suggestions/$experience_id[]",
		// '#experience':  "/experiences/$experience_id"


// rooms/<ID>[] { assignments, starttime, is_full }  assignments= { role: name }
// actions/<room_id>[] { who, what }
// experience/<ID>/{ authors, place }
// suggestions/<ID>/to:<role>[] { who, what, tupe }
// audio/<ID>/{ song, state, t0 }


Fireball("https://songwalks.firebaseio.com/", {

   init: function(){
      var audio = document.querySelector('audio');
      window.dyn = F.dynamic("audio/$experience_id");

	  audio.addEventListener('play', function(){
	  	dyn.update({state: 'playing'});
	  })

	  audio.addEventListener('pause', function(){
	     dyn.update({state: 'paused'});
	  })

      dyn.on('value', function(s){
		   if (audio.src != songName) audio.src = songName;
			var state = s.val() || 'paused:0';
			if (state == "playing") audio.play();
			else {
				audio.pause();
				// if (state == "paused:0") audio.currentTime = 0;
			}
	  });
	  
	  dyn.on('cleared', function(){ audio.pause(); });
	  audio.addEventListener('ended', function(){ alert('ended!'); });

	  record('Joe', 'rooster', '16th and valencia, sw corner');
   },

	map: {
		'#actions':     "/actions/$experience_id/$room_id[]",
		'#suggestions': "/live_suggestions/$experience_id[]",
		'#experience':  "/experiences/$experience_id"
	},

	on_submit: {
		'#suggestion_form': function(data){
		   Fireball('#suggestions').push({
		      who: my_name,
		      text: data[0].value
		   });
		   data[0].value = '';
		}
	},

   calculated_fields:{
      "#experience author_names":function(exp){
      	if (!exp.authors) return;
        return Object.keys(exp.authors).map(function(k){ return exp.authors[k]; }).join(', ');
      },

      "#experience did_what":function(exp){
         if (mode == 'record') return "are making an experience";
         else return "made this experience"; 
      },

      "#suggestions framing":function(sugg){
         if (mode == 'record') return sugg.who + " suggested";
         else return "Current suggestion is";
      },      

      "#audio_info sigil":function(aud){
         return "&#9654;";
      },

      "#actions ts":function(act){
         return "ts";
      }
   },

	on_click: {

		'#play': function(){
         dyn.update({state:"playing"});
		},

		'#pause': function(){
         dyn.update({state:"paused"});
		},

		'#accept_suggestion': function(b){
		   var data = b.parentNode.data;
			// also add it to experience for future people
			Fireball("#actions").push({
				who: my_name,
				what: "accepted the suggestion to " + data.text
			})
			var obj = {};
			obj[data.id] = null;
			Fireball('#suggestions').update(obj);
		},
		'#reject': function(b){
		   var data = b.parentNode.data;
			Fireball("#actions").push({
				who: my_name,
				what: "rejected the suggestion to " + data.text
			});
			Fireball('#suggestions').delete(data.id);
		},
		'.suggestion_type': function(){
			// highlight it
			alert('unimplemented');
		}
	},
	
	show_when:{
	   "#suggestion_form": function(){ return mode == 'record'; }
	}
});


</script>
