<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
<script src="zepto.min.js"></script>
<script type='text/javascript' src='https://cdn.firebase.com/v0/firebase.js'></script>
<style type="text/css">
	#menu a, .menu a {
		display: block;
		padding: 10px;
		border: solid thin #eee;
		background: #ccc;
		text-decoration: none;
	}
</style>
<!--
## TODO

- display of recorded games has headers that group the game
- catalogue of open games / recorded games at site + add a game
- when you join you make a role (with your name)
- fix it on ios6
- abstract InstrumentedAudio
	- load(audioFile, play_pause_seek_firebase_ref,
		cues: [cue_points, cue_callback],
		on_ready_callback
	)
	- beep


- roles have names
	- Culver City Parking Lot
		- Jim and John appreciated Dina Maccabee's "The Rooster"
			- Play Jim
			- Play John
- locations menu before roles menu
- scratch game vs. recorded game
-->

<div id="home">
	<h2>Song Appreciation Quests</h2>

	<div id="location_picker">
		<p>Pick your location</p>
		<div class="menu">
			<div id="locations"></div>
			<a href="javascript:add_location()">Add a location...</a>
		</div>
	</div>

	<div id="role_picker">
		<p>
			You're at <span id="location_name"></span>
			<a href="javascript:back()">(change)</a>
		</p>
		<div id="menu">
			<h2>Open Parts</h2>
			<div id="recordables"></div>
			<a href="javascript:new_songwalk()">new quest</a>

			<h2>Recorded Parts</h2>
			<div id="playables"></div>
		</div>
	</div>
</div>

<div id="device" style="display:none">
	<audio controls="yeah"></audio>
	<p id="instructions"></p>
	<div id="annotation_controls">
		<h2>Help your friend enjoy the song by sending messages.</h2>
		<div id="message_buttons" class="menu"></div>
	</div>
	<a href="javascript:back()">back</a>
</div>


<script type="text/javascript">

var F = new Firebase("https://songwalks.firebaseio.com/");
var uid = F.push().name();
var audio = document.querySelector('audio');
var instructions;
if (audio.addTextTrack) instructions = audio.addTextTrack('descriptions');

var FULL_TITLES = {
	rooster: "Dina Maccabees's \"The Rooster\""
};

function now(){ return (new Date()).getTime(); };

var current_role_name;
var current_walk;
var current_location;
var all_parts_snapshot;

function refresh(){
	if (current_location){
		$('#location_picker').hide();
		$('#role_picker').show();
	} else {
		$('#location_picker').show();
		$('#role_picker').hide();
	}
}

function add_location(){
	var name = prompt('Name');
	if (name){
		F.child('locations').push(name);
		current_location = name;
		$('#location_name').html(current_location);
		draw_parts();
		beep();
		refresh();
	}
}

function new_songwalk(){
	// in walks: set song and roles[]
	// in roles: set title, walk, city
	var song = prompt('Song:');
	if (!song) return;
	var role_count = Number(prompt('How many players?'));
	if (!role_count) return;
	var role_ids = [];
	var title = FULL_TITLES[song] + " for " + role_count + " players, at " + current_location;
	var walk = F.child('walks').push({
		title: title,
		song: song,
		city: "lax"
	});
	for (var i = 0; i < role_count; i++) {
		var role = F.child('roles').push({
			walk: walk.name(),
			city: 'lax',
			location: current_location,
			title: "Player " + (i+1) + " for " + FULL_TITLES[song]
		})
		walk.child('roles').push(role.name());
	};
}



F.child('locations').on('value', function(v){
	$('#locations').empty();
	v.forEach(function(l){
		var link = $('<a href="#">' + l.val() + '</a>');
		link.appendTo('#locations').on('click', function(){
			current_location = l.val();
			beep();
			$('#location_name').html(current_location);
			draw_parts();
			refresh();
			return false;
		});
	});
});

function draw_parts(v){
	if (!v) v = all_parts_snapshot;
	all_parts_snapshot = v;
	$('#recordables').empty();
	$('#playables').empty();
	v.forEach(function(r){
		var role = r.val();
		if (role.location && current_location && current_location != role.location) return;
		if (!role.recorded_at){
			var title = "record " + role.title;
			var link = $('<a href="#">' + title + '</a>');
			link.appendTo('#recordables').on('click', function(){
				r.ref().child('recorded_at').set(now());
				current_role_name = r.name();
				attach_device_to_walk(F.child('walks').child(role.walk));
				configure_as_recorder();
				return false;
			});
		} else if (!role.taken_at || five_minutes_ago(role.taken_at)) {
			var title = "play " + role.title;
			var link = $('<a href="#">' + title + '</a>');
			link.appendTo('#playables').on('click', function(){
				beep();
				r.ref().child('taken_at').set(now());
				current_role_name = r.name();
				attach_device_to_walk(F.child('walks').child(role.walk));
				configure_as_player();
				return false;
			});			
		}
	});
}

F.child('roles').on('value', draw_parts);

function configure_as_recorder(){
	current_walk.child('roles').once('value', function(v){
		$('#message_buttons').empty();
		v.forEach(function(r){
			var role_name = r.val();
			var title = "Add instruction for " + role_name;
			if (role_name == current_role_name) title = "Add instruction for yourself";
			var link = $('<a href="#">' + title + '</a>');
			link.appendTo('#message_buttons').on('click', function(){
				add_instructions(role_name);
				return false;
			});
		});
		$('#annotation_controls').show();
	});

	current_walk.child('events').on('child_added', function(child){
		var instruction = child.val();
		if (instruction.role == current_role_name){
			// for me!
			// who sent it?
			var what;
			if (instruction.from == current_role_name){
				what = "<b>You</b> sent yourself an instruction: <br>";
			} else {
				what = "<b>" + instruction.from + "</b> sent an instruction: <br>";
			}
		  	$('#instructions').html(what + instruction.text);				
		  	beep();
		}
	});
}

function add_instructions(to_role){
	var audio = document.querySelector('audio');
	var text = prompt('What instructions?');
	if (!text) return;
	current_walk.child('events').push({
		from: current_role_name,
		role: to_role || current_role_name,
		t: audio.currentTime,
		text: text
	});
}

function five_minutes_ago(t){
	return now() - t > 20*1000;
}

function back(){
	current_location = null;
	detach_device();
	draw_parts();
	refresh();
}


function detach_device(){
	if (!current_walk) return;
	current_walk.child('song').off();
	InstrumentedAudio.unload();
	current_walk = null;
	$('#device').hide();
	$('#home').show();
	if (instructions){
		var cues = instructions.cues;
		for (var i = 0; i < cues.length; i++) {
			instructions.removeCue(cues[i]);
		};
	}
	$('#instructions').empty();
}





function configure_as_player(){
	$('#annotation_controls').hide();
	current_walk.child('is').set('paused:0');
}

// only when player!
function on_cue(e){
	if (e.text && e.role == current_role_name){
	  	$('#instructions').html(e.text);
	  	beep();
	}
}

function attach_device_to_walk(walk){
	detach_device();
	current_walk = walk;
	walk.once('value', function(v){
		var quest = v.val();
		InstrumentedAudio.load(quest.song + ".mp3", walk.child('is'), {
			cues: [quest.events, on_cue],
			onended: back,
			onload: function(){
				// loaded!
				$('#home').hide();
				$('#device').show();
			}
		})
	});
}


// 		if (instructions) instructions.addCue(new TextTrackCue(e.t, e.t+3, e.text));

	// instructions.oncuechange = function (){
	//   var cue = this.activeCues[0]; // assuming there is only one active cue
	// };

InstrumentedAudio = {
	unloaders: [],

	init: function(){
		if (InstrumentedAudio.initted) return;
		InstrumentedAudio.initted = true;
		audio.addEventListener('play', function(){
			if (current_walk) current_walk.child('is').set('playing');
		})
		audio.addEventListener('pause', function(){
			if (current_walk) current_walk.child('is').set('paused');
		})
	},

	load: function (songName, controllerRef, options){
		if (!options) options = {};
		InstrumentedAudio.init();
		// TODO load the audio
		// TODO load the cues
		// TODO call the loaded cb
		InstrumentedAudio.unload();
		audio.src = songName;
		InstrumentedAudio.unloaders.push(function(){
			controllerRef.off();
		});
		InstrumentedAudio.current_controllerRef = controllerRef;
		controllerRef.on('value', function(s){
			var state = s.val() || 'paused:0';
			if (state == "playing") audio.play();
			else {
				audio.pause();
				if (state == "paused:0") audio.currentTime = 0;
			}
		});

		if (options.onended){
			audio.addEventListener('ended', options.onended);
			InstrumentedAudio.unloaders.push(function(){ 
				audio.removeEventListener('ended', options.onended);
			});
		}
	},

	unload: function(){
		audio.pause();
		InstrumentedAudio.unloaders.forEach(function(x){ x(); });
	}
};




refresh();


var beep = (function () {
    var ctx = new(window.audioContext || window.webkitAudioContext);
    return function (duration, type, finishedCallback) {
    	if (!duration) duration = 200;
    	if (!type) type = 0;
        duration = +duration;
        type = (type % 5) || 0;  // Only 0-4 are valid types.
        if (typeof finishedCallback != "function") {
            finishedCallback = function () {};
        }
        var osc = ctx.createOscillator();
        osc.type = type;
        osc.connect(ctx.destination);
        osc.noteOn(0);
        setTimeout(function () {
            osc.noteOff(0);
            finishedCallback();
        }, duration);
    };
})();





// LATER
// - paused mode should seek
// - drag should go to paused 0
// - add photo taking


// ## SCHEMA

// // changes slowly, as roles are declared and recorded
// roles: [{
// 	title: "",
// 	recorded_at: 0,
// 	taken_at: 0,
// 	walk: "",
// 	city: ""
// }]

// // changes quick as events added and playstate changes
// walks: {
// 	id: {
// 		song: "rooster",
// 		is: "playing/paused",
// 		events: [[t, ev], [t, ev]],
// 		roles: []
// 	}
// }





// var engine = {
// 	current_script: null,
// 	current_role: null,
// 	scripts: {},

// 	script: function (song, obj, cb) {
// 		obj.song = song;
// 		obj.roles = {};
// 		engine.current_script = obj;
// 		engine.scripts[song] = obj;
// 		cb(engine);
// 	},

// 	role: function(name, count, cb){
// 		engine.current_role = {
// 			name: name,
// 			count: count,
// 			moves: []
// 		};
// 		engine.current_script.roles[name] = engine.current_role;
// 		cb(engine);
// 	},

// 	move: function(time, alert){
// 		engine.current_role.moves.push({
// 			t: time,
// 			alert: alert
// 		});
// 	},

// 	play: function(song, role){
// 		var audio = document.querySelector('audio');
// 		audio.src = song + ".mp3";
// 		var dance = engine.scripts[song];
// 		var track = audio.addTextTrack('descriptions');
// 		var moves = dance.roles[role].moves;
// 		for (var i = moves.length - 1; i >= 0; i--) {
// 			var move = moves[i];
// 			track.addCue(new TextTrackCue(move.t, move.t+3, move.alert));
// 		};

// 		track.oncuechange = function (){
// 		  var cue = this.activeCues[0]; // assuming there is only one active cue
// 		  console.log(cue && cue.text);
// 		  if (cue) alert(cue.text);
// 		};

// 		// audio.play();
// 	}
// };

// engine.script('rooster', {
// 	latlng: [37.811729, -122.269964],
// 	city: "Oakland, CA",
// 	neighborhood: "Downtown",
// 	title: "Oakland Rooster",
// 	count: 1,
// }, function(_){
// 	_.role("Orsino", 1, function(){

// 		_.move(3, "Wonder about life.");
// 		_.move(30, "Duck down like a duck ducking down.");
// 		_.move(45, "Touch your heart.");
// 		_.move(60, "Lie on your back for the rest of the song.");

// 	});
// });

// engine.play('rooster', "Orsino");

</script>





